%!TEX root = thesis.tex
\chapter{Theoretical limits for localisation microscopy \label{sec:Theoretical-limits-of the LM}}

In this chapter, we discuss the limits of the localisation microscopy (LM) from the theoretical point of view. In \autoref{sec:FREM} we compare the the classical resolution limit with fundamental resolution measure (FREM), introduced by Ram et al. \cite{Ram2006} to accommodate for situation of noisy, pixelised data. 

\Autoref{sec:CR} introduces the \CR lower bound used by Ram et al. to derive a FREM formula (\autoref{sec:FREM orig}). In \autoref{sub:An-alternative-derivation-FREM} we derive an alternative form of FREM and show that this version fixes strange and inconsistent behaviour of the original FREM for sources of unequal intensity.

In \autoref{sec:FREM for blinking} we derive FREM for two emitters with intermittent intensity (blinking sources). \Autoref{sec:FREM results} compares FREM for blinking and static sources in different experimental conditions.

Details of all derivations are shown in \autoref{app:Appendix2}.

%==========================================
%==========================================
\section{Fundamental resolution measure (FREM)\label{sec:FREM}}

The ability of an optical microscope to show spatial details in the specimen structure is fundamentally limited by diffraction. The radius of an airy disk is often considered as a ``classical resolution limit''. It is given by
%
\begin{equation}
 	\delta=0.61\frac{\lambda}{NA}, 
	\label{eq:Airy}
\end{equation}
%
where $\lambda$ is a wavelength of the emitted light and $NA$ is a numerical aperture of the objective. This resolution limit comes from the empirical observation that if two sources are separated by a distance grater then $\delta$, then we can ``resolve'' them as two individual objects. If the separation is smaller then $\delta$ then the point spread functions of the two sources merge together to create a single object and sources therefore become ``unresolved''. The simplicity of the expression and the clear interpretation makes this limit popular in the microscopy community and is usually taken as a bench mark for the resolution techniques. However, being an empirical observation, the classical resolution limit does not take into account the statistical nature of the photon detection process. It applies to the noise-free situation with continuous representation of the point spread functions (detection with infinitely small pixels). \Autoref{eq:Airy} is sometimes called ``Raleigh resolution limit''. Note that Abbe resolution limit $\delta=0.5\frac{\lambda}{NA}$ related to the passband of spatial frequencies is also often used.

Ram et al. \cite{Ram2006,Ram2006b} revised the resolution limit and defined a new measure, which considers the statistical process of the photon detection on a pixellated grid of a camera. The so called \emph{Fundamental resolution limit} (FREM) refers to the achievable precision of the estimator on distance between two sources. FERM reflects the fact, that the ``resolution limit'' is different for sources with different noise levels. The necessary separation between two sources in order to be ``resolved'' is smaller for bright, noise-free sources than for weak noisy emitters.

Ram et al. defined FREM as a \CR lower bound on the standard deviation of the source separation estimation. FREM therefore does not provide ``resolution criterion'' such as \autoref{eq:Airy}, but gives as a notion about variability we can expect if we try to measure the distance between two sources. We can set a ``resolution'' limit arbitrarily according to the measurement precision we are willing to accept. A natural choice for the resolution criterion for given experimental conditions, namely intensity of the sources and background levels, is then the distance between the sources, which is equivalent to FREM. For this distance the standard deviation of the source separation measurement is equal to the separation itself. This ``natural resolution criterion'' is used throughout this chapter. 

It is important to note that FREM defined as a \CR lower bound does not consider any specific algorithm for the separation estimation. It is derived from the generative model of the dataset and is therefore valid for the ``best'' possible algorithm we can use. 

%For the standard LM techniques such as PALM and STORM \cut{(\autoref{sub:PALM,-STORM})} the spatial resolution limit is determined by the localisation precision for an individual source, because only individual, well separated sources are considered for localisation. 

%The \CR lower bound for the position estimation of a single source detected by a CCD camera is derived in \cite{Ram2006,Ram2006b}. The variance is shown to be proportional to $1/\Lambda$, where $\Lambda$ is the number of photons emitted by the source. 

%==========================================
%==========================================

\section{\CR lower bound\label{sec:CR}}

\CR lower bound is a theoretical framework for description of the estimator covariance matrix. If $\mathcal{L}(\theta)=\log p(x|\theta)$ is a log-likelihood function for data $X$, then a covariance matrix $\bm{Q}$ of an unbiased estimator of $\hat{\theta}$ is bounded by \cite{Rao1945,Cover1991} 
%
\begin{equation}
	\bm{Q}\geq\bm{I}^{-1}(\theta),
	\label{eq:Covariance vs Fisher information}
\end{equation}
%
where $\bm{I}(\theta)$ is the Fisher information matrix can be expressed in two equivalent formulas
%
\begin{equation}
	I_{ij}(\theta)=-\E\left[\frac{\partial^2\mathcal{L}}{\partial\theta_i\partial\theta_j}\right]=\E\left[\frac{\partial\mathcal{L}}{\partial\theta_i}\frac{\partial\mathcal{L}}{\partial\theta_j}\right].
	\label{eq:Fisher information general}
\end{equation}

The inequality \autoref{eq:Covariance vs Fisher information} is in the sense that $\bm{Q}-\bm{I}^{-1}(\theta)$ is a non-negative definite matrix.

%==========================================
%==========================================
\section{Original FREM formula\label{sec:FREM orig}}

Ram et al. \cite{Ram2006} considered two sources separated by a distance $d$ and derived Fisher information
%
\begin{equation}
	I(d)=\frac{1}{4}\sum_{k=1}^N\frac{\left[\Lambda_1q_k'(-\frac{d}{2})-\Lambda_2q_k'(\frac{d}{2})\right]^2}{\Lambda_1q_k(-\frac{d}{2})+\Lambda_2q_k(\frac{d}{2})+b},
	\label{eq:Ram FREM}
\end{equation}
%
where $\Lambda_i$ is the intensity of the $i$th source, $b$ is the background level in each pixel, $q_k(z)=\int_{\Gamma_k}q(x-z)dx$ is the pixelised version of a point spread function translated by $z$ with $\Gamma_k$ being an area of the $k$th pixel, and $q'_k(z)=\int_{\Gamma_k}\frac{\partial q(x-z)}{\partial x}dx$ is the corresponding pixelised derivative. 

Inverse of Fisher information bounds the variance of the estimator on $d$ 
%
\begin{equation}
	\var(d)\geq I^{-1}(d).
\end{equation}
%
FREM as a lower bound on the standard deviation is therefore
%
\begin{equation}
	\unit{FREM}=\sqrt{I^{-1}(d)}.
	\label{eq:FREM}	
\end{equation}

A short summary of the derivation is shown in \autoref{app:Appendix2}. 

However, closer inspection of FREM derived from Fisher information given by \autoref{eq:Ram FREM} reveals problematic behaviour of FREM in the limits $d\rightarrow 0$ (see discussion in \autoref{app:Appendix2}). The limit of very close emitters $d\rightarrow0$ gives, as we would expect, zero Fisher information $I(d)\rightarrow0$, and therefore FREM$\rightarrow\infty$. However this is only for situation, when the sources have equal intensities $\Lambda_1=\Lambda_2$. For emitters of unequal strength $\Lambda_1\neq\Lambda_2$ the variance remains finite even for sources infinitely close. 

Another serious problem with this expression is that the sources are assumed to be located at $\pm d/2$, which implicitly assumes the knowledge of the origin. It is therefore not surprising that the formula \autoref{eq:Ram FREM} gives $I(d)\neq0$ (i.e. finite FREM) even for the situation when one source is missing ($\Lambda_i=0$), because, in fact, only one source is needed to determine the distance $d/2$. 

In the following section we present an alternative derivation of FREM, which fixes this strange behaviour. Our version gives diverging FREM for $d\rightarrow0$ for sources with different intensities. It also diverges in the situation when one of the source is missing. For sources with equal intensities $\Lambda_1=\Lambda_2$ our version and the original version of FREM give identical results. 

%==========================================
%==========================================

\section{An alternative derivation of the FREM\label{sub:An-alternative-derivation-FREM}} 
 
We assume two sources located along a line at positions $c_1$ and $c_2$ with intensities $\Lambda_1$ and $\Lambda_2$, respectively. If both sources have identical PSF (here denoted as $q(x)$) we can express the intensity as:
%
\begin{equation}
	\lambda(\bm{c})=\Lambda_1q(x-c_1)+\Lambda_2q(x-c_2).
	\label{eq:lambda}
\end{equation}
%
The distance between the two sources is $d=c_1-c_2$, which is a linear combination $\bm{a}^{T}\cdot\bm{c}$ of the variable $\bm{c}=(c_1,c_2)^{T}$, where $\bm{a}=(1,-1)^{T}$. The variance of $d$ is therefore given by 
%
\begin{alignat}{2}
	\var(d)
	&=\var(\bm{a}^{T}\cdot\bm{c})\nonumber\\
	&=\bm{a}^{T}\cdot\bm{Q}\cdot\bm{a},
	\label{eq:var d from Q}
\end{alignat}
%
where $\bm{Q}$ is the covariance matrix with lower bound given by the inverse of the Fisher information matrix (see \autoref{eq:Covariance vs Fisher information} and \autoref{eq:Fisher information general}):
%
\begin{equation}
	\bm{Q}\geq\bm{I}^{-1}(\bm{c})=\frac{1}{I_{11}I_{22}-I_{12}^2}\left(
	\begin{array}{cc}
		I_{22} & -I_{12}\\
		-I_{12} & I_{11}
	\end{array}\right).
	\label{eq:inverse I}
\end{equation}
%
Expressing the elements of the covariance matrix $\bm{Q}$ from \autoref{eq:inverse I} and substitution to \autoref{eq:var d from Q} gives the expression for $\var(d)$ from the elements of the Fisher information matrix
%
\begin{alignat}{2}
	\var(d)
	&=Q_{11}+Q_{22}-2Q_{12}\nonumber\\
	&\geq\frac{I_{11}+I_{22}+2I_{12}}{I_{11}I_{22}-I_{12}^2}.
	\label{eq:variance d alternative}
\end{alignat}

We assume that the recorded images are corrupted with Poisson noise only (denoted here as $\Po(n;\lambda)$, or sometimes in a shorter version $\Po(\lambda)$, leaving only the expectation value $\lambda$ as an argument). The probability distribution of $n_k$ photons detection in the $k$th pixel is therefore
%
\begin{equation}
	p(n_k|\bm{c})=\Po\left(n_k;\lambda_k(\bm{c})\right),
\end{equation}
%
where $\lambda_k$ is the expected intensity in pixel $k$. It is obtained by integration of the intensity distribution $\lambda(x)$ from \autoref{eq:lambda} over the area of a pixel $\Gamma_k$:
%
\begin{equation}
	\lambda_k(\bm{c})=\int_{\Gamma_k}\Lambda_1q(x-c_1)+\Lambda_2q(x-c_2)dx+b.	
	\label{eq:intensity pixel}
\end{equation}
%
Constant $b$ is a homogeneous background in each pixel.

If we suppose uncorrelated noise between pixels, we get the log-likelihood function for $N$ pixels: 
%
\begin{equation}
	\mathcal{L}=\sum_{k=1}^N\log p(n_k|\bm{c})=\sum_{k=1}^N\log\left[\Po\left(n_k;\lambda_k(\bm{c})\right)\right].
	\label{eq:FREM likelihood Poisson}
\end{equation}
%
Inserting $\mathcal{L}$ into \autoref{eq:Fisher information general}, the elements of the Fisher information matrix become (see \autoref{eq:app-Fisher Information alternative - Individual} in \autoref{app:Appendix2} for details)
%
\begin{equation}
	I_{ij}(\bm{c})=\sum_{k=1}^N\frac{1}{\lambda_k}\frac{\partial\lambda_k}{\partial c_i}\frac{\partial\lambda_k}{\partial c_j};\; \ i,j=\{1,2\}.
	\label{eq:FI - entries}
\end{equation}
%
By substitution from \autoref{eq:intensity pixel} we get for the individual elements of the Fisher information matrix (see \autoref{eq:app-Fisher Information alternative - Individual} in \autoref{app:Appendix2} for details): 
%
\begin{equation}
	I_{ij} =\Lambda_i\Lambda_j\sum_{k=1}^{K}\frac{q'_k(c_i)q'_k(c_j)}{\Lambda_1q_k(c_1)+\Lambda_2q_k(c_2)+b};\; \ i,j=\{1,2\},
	\label{eq:FI - individual}
\end{equation}
%
where $q_k(c_i)$ and $q'_k(c_i)$ are the pixelised versions (pixel area $\Gamma_k$) of the PSF and the derivative, respectively:
%
\begin{alignat*}{2}
	q_k(c_i) & =\int_{\Gamma_k}q(x-c_i)dx\\
	q'_k(c_i) & =\int_{\Gamma_k}\frac{\partial q(x-c_i)}{\partial x}dx.
\end{alignat*}
%

For equally strong sources ($\Lambda_1=\Lambda_2=\Lambda$) we get a compact expression for the entries of the Fisher information: 
%
\begin{equation}
	I_{ij} =\Lambda\sum_{k=1}^{K}\frac{q'_k(c_i)q'_k(c_j)}{q_k(c_1)+q_k(c_2)+b/\Lambda};\; \ i,j=\{1,2\},
	\label{eq:FI - individual - equal strength}
\end{equation}
%
and due to symmetry of the entries ($I_{11}=I_{22}$ and $I_{12}=I_{21}$) the variance can be expressed as
%
\begin{equation}
	\var(d)\geq\frac{2}{I_{11}-I_{12}}.
	\label{eq:var symmetric}
\end{equation}
%
Inserting the matrix elements \autoref{eq:FI - individual - equal strength} into \autoref{eq:var symmetric} shows that for situations where the background level is considerably smaller then the intensity $b/\Lambda\ll1$, the lower bound on variance scales as
%
\begin{equation}
	\var(d)\propto\frac{1}{\Lambda}. 
\end{equation}
%
However, the exact value depends on the shape of the PSF $q(x)$.

In \autoref{app:Appendix2} (see \autoref{eq:app-equivalence FREM orig and us}) we show the equivalence of FREM computed from the original Fisher information formula \autoref{eq:Ram FREM} and our version \autoref{eq:FI - individual} for sources with equal strength ($\Lambda_1=\Lambda_2$). However, as we demonstrate in \autoref{sec:comparison orig and new FREM}, the expressions gives very different results for sources of unequal intensity. 

FREM computed from \autoref{eq:FI - individual} have reasonable behaviour in the limits $d\rightarrow0$ and $d\rightarrow\infty$ (see \autoref{sec:Appendix FI alternative} for details). The limit of very close sources ($d\rightarrow0$) gives FREM$\rightarrow\infty$ for any value of $\Lambda_i$ and $\Lambda_j$. Also, in contrast to the original FREM expression, FREM diverges if one of the sources is zero $\Lambda_i=0$, because we do not make any assumption about the symmetry with respect to the origin. 

For well separated sources ($d\rightarrow\infty$) the off-diagonal elements of the Fisher information matrix vanish ($I_{ij}=0$ for $i\neq j$) and from \autoref{eq:variance d alternative} we get
%
\begin{equation}
 	\var(d)\geq\frac{1}{I_{11}}+\frac{1}{I_{22}}.
\end{equation}
%
Fraction $1/I_{ii}$ is the lower bound for the variance of an individual source $s_i$ localisation. The bound on the total variance is therefore composed from the sum of bounds on variances for localisation of individual sources, as we expect.


%==========================================
%==========================================

\section{FREM for blinking sources\label{sec:FREM for blinking}}

Fundamental resolution measure discussed in the previous section considers only the total number of photons $\Lambda_i$ emitted by each source $s_i$. In this section we derive FREM for sources with intermittent intensity and compare it to the ``static'' FREM derived above. 

To address this question we assume a simple model of Poisson distributed data with expected pixel values $\lambda_k$ (\autoref{eq:intensity pixel}). To account for the intermittent behaviour of the intensity, we turn the intensity vector $\bm{\Lambda}=(\Lambda_1,\Lambda_2)$ into a random variable distributed over four distinctive states (indexed with a superscript):
%
\begin{equation}
	\left\{ \bm{\Lambda}^{\alpha=1}=(\Lambda_1,0),\,\bm{\Lambda}^{\alpha=2}=(0,\Lambda_2),\,\bm{\Lambda}^{\alpha=3}=(\Lambda_1,\Lambda_2),\,\bm{\Lambda}^{\alpha=4}=(0,0)\right\},
	\label{eq:intensity states}
\end{equation}
%
which is a simple model of, for example, two blinking quantum dots. The expected intensity in the $k$th pixel when $\bm{\Lambda}$ is in the state $\bm{\Lambda}^\alpha$ is then $\lambda_k^\alpha=\lambda_k(\bm{\Lambda}^\alpha)$:
%
\begin{alignat}{4}
	\lambda_k^{\alpha=1}&=\Lambda_1q_k(x-c_1) & &+b,\nonumber\\ 
	\lambda_k^{\alpha=2}&=&\Lambda_2q_k(x-c_2) &+b,\nonumber\\ 
	\lambda_k^{\alpha=3}&=\Lambda_1q_k(x-c_1)&+\Lambda_2q_k(x-c_2)&+b,\nonumber\\ 
	\lambda_k^{\alpha=4}&=& &+b,
	\label{eq:lambda states}
\end{alignat}
%
where homogeneous background $b$ was added to each pixel.

%==========================================
\subsection{Averaging Fisher information\label{sub:avg FI}}

The ``averaging'' of the Fisher Information matrix presented in this section assumes knowledge of the intensity state (ON/OFF) of each source in every acquired frame. This information is not accessible in the real situation. However, we show the derivation to emphasise the difference between this approach and the more realistic situation, where the intensity states are described by probability distribution (\autoref{sub:FI int out}). 

If the intensity states $\bm{\Lambda}$ \emph{were known}, we would write the log-likelihood function as 
%
\begin{equation}
	\mathcal{L}(\theta,\Lambda)=\sum_{k=1}^K\log\left(l_k(\theta,\bm{\Lambda})\right).
\end{equation}
%
and the expected Fisher information matrix would become (see \autoref{app:Appendix2} for details)
%
\begin{equation*}
	I(\theta) = \int_{\bm{\Lambda}}p(\bm{\Lambda})I_{\bm{\Lambda}}(\theta)d\bm{\Lambda},
\end{equation*}
%
where $I_{\bm{\Lambda}}(\theta)$ is the Fisher information computed for a specific value of $\bm{\Lambda}$ (see \autoref{eq:FI - entries}).
%
For discrete states of $\bm{\Lambda}$ shown in \autoref{eq:lambda states} we get
%
\begin{equation}
	I(\theta)=\sum_{\alpha}p(\bm{\Lambda^\alpha})I_{\bm{\Lambda^\alpha}}(\theta),
	\label{eq:FI avg}
\end{equation}
%
where the Fisher Information for every configuration of $\bm{\Lambda^\alpha}$ is averaged with weights $p(\bm{\Lambda^\alpha})$. 


%%
%\begin{equation}
%	I_{ij}(\bm{c})=\sum_{t=1}^T\sum_{\alpha=1}^4p(\bm{\Lambda}^\alpha_t)\sum_{k=1}^N\frac{1}{\lambda_k(\bm{c},\bm{\Lambda}^\alpha_t)}\frac{\partial\lambda_k(\bm{c},\bm{\Lambda}^\alpha_t)}{\partial c_i}\frac{\partial\lambda_k(\bm{c},\bm{\Lambda}^\alpha_t)}{\partial c_j},
%	\label{eq:Fisher Information Blinking Cheating}
%\end{equation}
%%
%which is the expectation value (with respect to the states $\bm{\Lambda}$) of the Fisher information matrix \autoref{eq:FI - entries} for each time frame, followed by the summation over all frames.

%==========================================

\subsection{Integrating over the intensity states\label{sub:FI int out}}
%
However, we assume that the variable $\bm{\Lambda}$ is fully described by the probability $p(\bm{\Lambda})$ over the states. The exact state in time frame is unknown. Therefore we have to integrate over $\bm{\Lambda}$ and the likelihood function is then
%
\begin{alignat}{2}
	l(\theta)
	&=\prod_{k=1}^Np(n_k|\theta)\nonumber\\
	&=\prod_{k=1}^N\int_{\bm{\Lambda}}p(n_k,\bm{\Lambda}|\theta)\nonumber\\
	&=\prod_{k=1}^N\sum_{\alpha=1}^4p(n_k|\theta,\bm{\Lambda}^\alpha)p(\bm{\Lambda}^\alpha).
	\label{eq:FREM likelihood Lambda integrated out}
\end{alignat}
%
This complicates the evaluation of the Fisher information matrix \autoref{eq:Fisher information general} because of the summation within the logarithm in the log-likelihood
%
\begin{equation}
	\mathcal{L}(\theta)=\log l(\theta)=\sum_k\log\left(\sum_{\alpha=1}^4p(n_k|\theta,\bm{\Lambda}^\alpha)p(\bm{\Lambda}^\alpha)\right).
	\label{eq:log likelihood integrated out}
\end{equation}
%
In \autoref{app:Appendix2} we show that the Fisher information matrix for uniform distribution $p(\bm{\Lambda}^\alpha)=\frac{1}{4}$ over the four intensity states \autoref{eq:intensity states} is given by
%
\begin{equation}
	I_{rs}(\theta) =\sum_{k=1}^N\E_k\left[\frac{\left(\sum_{\alpha=1}^4\frac{\partial\Po(\lambda_k^\alpha)}{\partial c_r}\right)\left(\sum_{\alpha=1}^4\frac{\partial\Po(\lambda_k^\alpha)}{\partial c_s}\right)}{\left(\sum_{\alpha=1}^4\Po(\lambda_k^\alpha)\right)^2}\right],
	\label{eq:Fisher Information Blinking Integrating Out}
\end{equation}
%
where $\E_k\left[.\right]$ represents the expectation value with respect to $p(n_k,\bm{\Lambda}|\theta)$ (see \autoref{eq:log likelihood integrated out}). 

Expressing the derivatives and the expectation value gives
%
\begin{alignat}{2}
	I_{rs}(\theta)
	&=\frac{1}{4}\sum_{k=1}^N\left(\frac{\partial\lambda_k^{\alpha=r}}{\partial c_r}\right)\left(\frac{\partial\lambda_k^{\alpha=s}}{\partial c_s}\right)\times \nonumber\\
	&\times \sum_{n_k\geq0}\left[\frac{\left(\sum_{\alpha=\{r,3\}}\Po(n_k;\lambda_k^\alpha)\frac{(n_k-\lambda_k^\alpha)}{\lambda_k^\alpha}\right)\left(\sum_{\alpha=\{s,3\}}\Po(n_k;\lambda_k^\alpha)\frac{(n_k-\lambda_k^\alpha)}{\lambda_k^\alpha}\right)}{\sum_{\alpha=1}^4\Po(n_k;\lambda_k^\alpha)}\right].
	\label{eq:FI-blinking}
\end{alignat}
%
In \autoref{app:Appendix2} we show that the limit $d\rightarrow0$ gives $\var(d)\rightarrow\infty$ and the limit $d\rightarrow\infty$ gives $\var(d)\geq\frac{1}{I_{11}}+\frac{1}{I_{22}}$. We also show, that for well separated sources ($d\rightarrow\infty$) and negligible background ($b\ll\Lambda$) the variance $\var(d)$ is identical for both blinking and static situation, if the total number of emitted photons is kept constant. 

%==========================================
%==========================================
\clearpage
\section{Experimental parameters and numerical evaluations\label{sec:FREM simulations}} 
We made a comparison of the original FREM formula computed from Fisher information \autoref{eq:Ram FREM} with our proposed fixed FREM formula computed from \autoref{eq:FI - individual}, describing situation for static sources. We also compared the static situation with FREM for sources with intermittent intensity computed from \autoref{eq:FI-blinking}.

We considered $625\unit{nm}$ emission light wavelength and $1.2\unit{NA}$ numerical aperture of the microscope. Images were pixelised with $80\times80\unit{nm}$ pixels. Various intensity of the emitters $\Lambda_i$ and pixel background levels $b$ were considered.

The pixelised version $q_k(c_i)$ of the continuous PSF $q(x-c_i)$ and the corresponding derivatives $q'_k(c_i)$ from \autoref{eq:Ram FREM} and \autoref{eq:FI - individual} were computed by summing $10\times10$ pixels of $10\times$ oversampled images (approximation of the continuous PSF $q(x)$ on the $8\times8 \unit{nm}$ grid). The pixelised $\lambda^\alpha_k$ in \autoref{eq:Fisher Information Blinking Integrating Out} was computed in similar manner. 

Expectation values in \autoref{eq:Fisher Information Blinking Integrating Out} were evaluated using expression \autoref{eq:FI-blinking}. The set of images for a range $n_k=[0..n_{max}]$ was computed to perform the summation $\sum_{n_k\geq0}$. The value of $n_{max}$ was set such that the Poisson cumulative distribution function $F$ for the maximum intensity $\max_{k,\alpha}(\lambda_k^\alpha)$ satisfies $F(n>n_{max})>1-t$ with $t=10^{-6}$.

%==========================================
%==========================================

\clearpage
\section{Results\label{sec:FREM results}}

We computed the FREM values for simulated datasets corresponding to different experimental settings, such as separation of the sources $d$, total number of emitted photons by each source $\Lambda$ and the background offset $b$ in the recorded frames. FREM gives us the lower bound on standard deviation ($\sqrt{\var(d)}$) on the source separation $d$ measurement. The source separation, which is equivalent to FREM ($d$=FREM) can be considered as a natural ``resolution limit'', which takes the statistical nature of the photon detection into account.

%==========================================
\subsection{Comparison of the original and proposed FREM formula\label{sec:comparison orig and new FREM}}
%
We compared FREM computed from the original \autoref{eq:Ram FREM} and our proposed \autoref{eq:FI - individual} formula of the Fisher information for two static static sources. It can be shown (see \autoref{app:Appendix2}), that if the sources have equal strength ($\Lambda_1=\Lambda_2$), both formulas give the identical results. However, for unequal sources $\Lambda_1\neq\Lambda_2$ the FREM values differ significantly. 

The sources $s_i$ were represented with an in-focus PSF centred at $c_i$. The intensity of $s_2$ was set to double of the intensity of $s_1$: $\Lambda_2=2\Lambda_1$. Three different intensity levels $\Lambda_1=500,\,3\cdot 10^3$ and $10^4$ photons with homogeneous background $b=100\unit{photons/pixel}$ were considered. 

\begin{figure}[hbt]
	\centering
	\newcommand{\wf}{.49\textwidth}
	\begin{tabular}{cc}
		\subfloat[FREM (fixed background 100 photons)]{\includegraphics[width=\wf]{\qd gFREM/images/FREM_statVsRAM_bg100fix}}
		&\subfloat[ratio]{\includegraphics[width=\wf]{\qd gFREM/images/FREM_staticVsRAM_ratio_bg100fix}}
	\end{tabular}	
	\caption{(a) Comparison of the original FREM formula computed from \autoref{eq:Ram FREM} (dashed line) and our proposed FREM formula \autoref{eq:FI - individual} (solid line) for two sources with intensities $\Lambda_2=2\Lambda_1$. The black dotted curve corresponds to FREM=$d$. This would be a straight line with unit gradient in a linear plot. (b) Ratio of the curves showing how many times is FREM higher for our proposed formula compared to the original formula. All three curves are identical as the ratio depends only on $\Lambda_1/\Lambda_2$.} 
	\label{fig:Comparison FREM Ram and fix}
\end{figure}
%
\Autoref{fig:Comparison FREM Ram and fix}\aaa\ shows FREM (lower bound on $\sqrt{\var(d)}$) for a range of sources separations $d$ evaluated with the original FREM, computed from \autoref{eq:Ram FREM} (dashed line) and our proposed FREM \autoref{eq:FI - individual} (solid line).
 
The original FREM formula gives consistently lower FREM (dashed curves are under the solid lines for the whole range of $d$ in \Autoref{fig:Comparison FREM Ram and fix}\aaa). Original formula (dashed curves) also tends to finite values even for $d\rightarrow 0$. \Autoref{fig:Comparison FREM Ram and fix}\bbb\ shows the ratio of the curves (our proposed FREM to the original FREM) and shows how many times is the original FREM lower when compared to our proposed expression. It can be shown that for a given distance $d$ the ratio is a function of $\Lambda_1/\Lambda_2$ and is therefore constant different intensities of $\Lambda_1$ for given separation $d$ (see \autoref{fig:Comparison FREM Ram and fix}\bbb), because in our case $\Lambda_1/\Lambda_2=1/2$.

The difference is less significant for larger separation of the sources and both formulas converge to the same value in the limit $d\rightarrow \infty$ (see \autoref{app:Appendix2} for details).

%==========================================
\subsection{FREM for static and blinking sources\label{sub:FREM static vs blinking}}
%
In order to compare the blinking situation \autoref{eq:Fisher Information Blinking Integrating Out} with the static case \autoref{eq:FI - individual} we evaluated FREM as a function of the source separation $d$. For the blinking situation we considered equal strength of the sources $\Lambda_1^{blink}=\Lambda_2^{blink}=2\Lambda$ and homogeneous background $b^{blink}$ in each pixel of each frame. Because the sources are ``ON'' only in 50\% of the cases (see \autoref{eq:lambda states}), the total number of emitted photons per source per frame is $\Lambda$. 

For the static case we considered the situation of two sources emitting with equal intensities. To keep the total number of emitted photons per frame equal to the blinking case described above, we set the intensity $\Lambda_1^{static}=\Lambda_2^{static}=\Lambda$. The background values are equal for blinking and static case $b^{blink}=b^{static}$.

\begin{figure}[!hbt]
	\centering
	\newcommand{\wf}{.49\textwidth}
	\begin{tabular}{cc}
		\subfloat[FREM (fixed $b=$100 phot/pixel)]{\includegraphics[width=\wf]{\qd gFREM/images/FREM_bg100fix}
		\label{fig:FREM fixed bg}}
		%For bg=0 the ratio should converge to 1/sqrt(2)=0.7
		&\subfloat[Ratio of the curves form (a)]{\includegraphics[width=\wf]{\qd gFREM/images/FREM_ratio_bg100fix}
		\label{fig:FREM ratio fixed bg}}\tabularnewline
		\subfloat[FREM (fixed $\Lambda=1500$ photons)]{\includegraphics[width=\wf]{\qd gFREM/images/FREM_int3000fix}
		\label{fig:FREM fixed int}}		
		%For bg=0 the ratio should converge to 1/sqrt(2)=0.7
		&\subfloat[Ratio of the curves form (c)]{\includegraphics[width=\wf]{\qd gFREM/images/FREM_ratio_int3000fix}
		\label{fig:FREM ratio fixed int}}
	\end{tabular}	
	\caption{{\it Left:} FREM (a) for fixed background $b=100$ photons and three different intensities $\Lambda$ of the sources and (c) for fixed total number of emitted photons $\Lambda=1500$ and three different values of background $b$. Dashed lines correspond to the blinking situation \autoref{eq:Fisher Information Blinking Integrating Out}, solid lines correspond the static situation \autoref{eq:FI - individual}. {\it Right:} Ratio $r$ of the static (solid) to blinking (dashed) curves showing how many times is FREM for the blinking situation lower compared to the static situation.}	
	\label{fig:FREM static blinking}
\end{figure}
%
Comparison of FREM as a function of separation $d$ for the blinking and the static case is shown in \autoref{fig:FREM static blinking}. Three different values of the total number of photons $\Lambda$ emitted by source were considered in a semi-logarithmic plot \autoref{fig:FREM fixed bg}. All curves are computed for a fixed background level $b=100$ photons/pixel. 

The ratio of the FREM curves
%
\begin{equation}
	r=\frac{\unit{FREM}^{static}(d)}{\unit{FREM}(d)}
	\label{eq:ratio}
\end{equation} 
%
for the blinking and the static case are shown in \autoref{fig:FREM ratio fixed bg}. The plot shows how many times is the FREM for the blinking situation lower when compared to the static situation.

\Autoref{fig:FREM fixed int} shows the FREM curves for three different background values $b$. The total number of emitted photons per source was set to $\Lambda =1.5\cdot 10^3$ photons. The difference between the curves is most pronounced for situation with low background levels (red curves). 

\begin{figure}[!b]
	\centering
	\newcommand{\wf}{.48\textwidth}
	\subfloat[Static]{
	\includegraphics[width=\wf]{\qd gFREM/images/FREM_Static_sep40fix}
	\label{fig:FREM int bg static}
	}
	\subfloat[Blinking]{
	\includegraphics[width=\wf]{\qd gFREM/images/FREM_IntOut_sep40fix}
	\label{fig:FREM int bg blinking}
	}\\
	\subfloat[Static - top view]{
	\includegraphics[width=\wf]{\qd gFREM/images/FREM_Static_flat_sep40fix}
	\label{fig:FREM int bg static top}
	}
	\subfloat[Blinking - top view]{
	\includegraphics[width=\wf]{\qd gFREM/images/FREM_IntOut_flat_sep40fix}
	\label{fig:FREM int bg blinking top}
	}
	\caption{{\it Top:} FREM for (a) static and (b) blinking situation for two sources separated by $d=40$ nm. {\it Bottom:} Top view on the surfaces. Red plane corresponds to situation when FREM is equal to the separation of the sources $d=40$ nm. The region above the red plane (in black) does not allow precise estimation of the separation $d$ ($\unit{FREM}>d$).}
	\label{fig:FREM int bg}
\end{figure}
%
To explore the fundamental resolution measure for different experimental settings we computed FREM for two sources separated by $d=40\unit{nm}$ for a range of background $b$ and intensity  $\Lambda$ values. \Autoref{fig:FREM int bg} compares the static (left) with the blinking (right) situation. The red plane corresponds to the limit $\unit{FREM}=d$, where the lower bound on standard deviation of the distance estimation $\sqrt{\var(d)}$ is equal to the distance $d$. In the region where the black surface is above the red plane, the distance estimation is very imprecise with standard deviation of the separation $d$ estimation is equal to of higher then the actual separation $d$. These (black) regions can be easily observed from the top view shown in the bottom plots of \autoref{fig:FREM int bg} showing the increase of the ``resolution region'' in the blinking case. 

For high signal-to-noise ratio data (bottom-left corner of the plots with high $\Lambda$, low $b$ cf. \autoref{fig:two sources int bg}) the lower bound on the standard deviation of the separation $d=40\unit{nm}$ estimation can be as low as $7\unit{nm}$ for the blinking case (\autoref{fig:FREM int bg blinking}). For the static case the values of FREM are approximately three times higher ($\sim 20\unit{nm}$,  \autoref{fig:FREM int bg static}). Note that the surface of for the blinking situation has much steeper increase from the sub $40\unit{nm}$ region than the surface for the static case.

%\clearpage
%\begin{figure}[!bt]
%	\centering
%	\newcommand{\wf}{.15\textwidth}
%	\newcommand{\dirim}{\qd gFREM/images/psf2/text_}
%	\newcommand{\vs}{.4}
%	\begin{tabular}{c|ccccc}
%		\begin{sideways}\hspace{\vs cm}$b=300$\end{sideways}
%		&\includegraphics[width=\wf]{\dirim int2500_bg300}
%		&\includegraphics[width=\wf]{\dirim int2000_bg300}
%		&\includegraphics[width=\wf]{\dirim int1500_bg300}
%		&\includegraphics[width=\wf]{\dirim int1000_bg300}
%		&\includegraphics[width=\wf]{\dirim int500_bg300}\\
%		\begin{sideways}\hspace{\vs cm}$b=200$\end{sideways}
%		&\includegraphics[width=\wf]{\dirim int2500_bg200}
%		&\includegraphics[width=\wf]{\dirim int2000_bg200}
%		&\includegraphics[width=\wf]{\dirim int1500_bg200}
%		&\includegraphics[width=\wf]{\dirim int1000_bg200}
%		&\includegraphics[width=\wf]{\dirim int500_bg200}\\
%		\begin{sideways}\hspace{\vs cm}$b=100$\end{sideways}
%		&\includegraphics[width=\wf]{\dirim int2500_bg100}
%		&\includegraphics[width=\wf]{\dirim int2000_bg100}
%		&\includegraphics[width=\wf]{\dirim int1500_bg100}
%		&\includegraphics[width=\wf]{\dirim int1000_bg100}
%		&\includegraphics[width=\wf]{\dirim int500_bg100}\\
%		\begin{sideways}\hspace{\vs cm}$b=10$\end{sideways}
%		&\includegraphics[width=\wf]{\dirim int2500_bg10}
%		&\includegraphics[width=\wf]{\dirim int2000_bg10}
%		&\includegraphics[width=\wf]{\dirim int1500_bg10}
%		&\includegraphics[width=\wf]{\dirim int1000_bg10}
%		&\includegraphics[width=\wf]{\dirim int500_bg10}\\
%		\hline
%		&$\Lambda=2500$ & $\Lambda=2000$ & $\Lambda=1500$ & $\Lambda=1000$ & $\Lambda=500$\\
%	\end{tabular}
%	\caption{Illustration of a simulated source with intensity $\Lambda$ (total number of emitted photons) and background level $b$ corrupted with Poisson noise. Red dot indicates the position of the source. The numbers $p$ in each frame shows the lower bound on localisation precision $p=\sqrt{var(c_1)}$ along one direction.}
%	\label{fig:PSF int bg}
%\end{figure}
%
\begin{figure}[!hbt]
	\centering
	\newcommand{\wf}{.15\textwidth}
	\newcommand{\dirim}{\qd gFREM/images/psf2/text_twosources_}
	\newcommand{\vs}{.4}
	\begin{tabular}{c|ccccc}
		\begin{sideways}\hspace{\vs cm}$b=300$\end{sideways}
		&\includegraphics[width=\wf]{\dirim int2500_bg300}
		&\includegraphics[width=\wf]{\dirim int2000_bg300}
		&\includegraphics[width=\wf]{\dirim int1500_bg300}
		&\includegraphics[width=\wf]{\dirim int1000_bg300}
		&\includegraphics[width=\wf]{\dirim int500_bg300}\\
		\begin{sideways}\hspace{\vs cm}$b=200$\end{sideways}
		&\includegraphics[width=\wf]{\dirim int2500_bg200}
		&\includegraphics[width=\wf]{\dirim int2000_bg200}
		&\includegraphics[width=\wf]{\dirim int1500_bg200}
		&\includegraphics[width=\wf]{\dirim int1000_bg200}
		&\includegraphics[width=\wf]{\dirim int500_bg200}\\
		\begin{sideways}\hspace{\vs cm}$b=100$\end{sideways}
		&\includegraphics[width=\wf]{\dirim int2500_bg100}
		&\includegraphics[width=\wf]{\dirim int2000_bg100}
		&\includegraphics[width=\wf]{\dirim int1500_bg100}
		&\includegraphics[width=\wf]{\dirim int1000_bg100}
		&\includegraphics[width=\wf]{\dirim int500_bg100}\\
		\begin{sideways}\hspace{\vs cm}$b=10$\end{sideways}
		&\includegraphics[width=\wf]{\dirim int2500_bg10}
		&\includegraphics[width=\wf]{\dirim int2000_bg10}
		&\includegraphics[width=\wf]{\dirim int1500_bg10}
		&\includegraphics[width=\wf]{\dirim int1000_bg10}
		&\includegraphics[width=\wf]{\dirim int500_bg10}\\
		\hline	
		&$\Lambda=2500$ & $\Lambda=2000$ & $\Lambda=1500$ & $\Lambda=1000$ & $\Lambda=500$\\
	\end{tabular}
	\caption{Illustration of two simulated sources separated by $d=40$ nm  with intensity $\Lambda$ (total number of emitted photons per source) and background level $b$ corrupted with Poisson noise. The red dots indicate the positions of the sources. The layout corresponds to \autoref{fig:FREM int bg}. Numbers in the top-left and bottom-left corner of each figure state the ratio $r_B=\unit{FREM}^{Blink}/d$ and $r_S=\unit{FREM}^{Stat}/d$ for the blinking and the static situation, respectively. The smaller the values, the higher the precision of the distance estimator.}
	\label{fig:two sources int bg}
\end{figure}
%
In \autoref{fig:two sources int bg} we show the noisy images of two sources with parameters $b$ and $\Lambda$ with layout corresponding to the graphs in \autoref{fig:FREM int bg}.  The black regions from \autoref{fig:FREM int bg static top} and \autoref{fig:FREM int bg blinking top} correspond to extremely noisy data (top right corner) and the high FREM values are not surprising. 

\begin{figure}[!bt]
	\centering
	\newcommand{\wf}{.13\textwidth}
	\newcommand{\dirim}{\qd gFREM/images/psf3/text_twosources_}
	\newcommand{\vs}{.1}
	\begin{tabular}{c|cccccc}
%		\begin{sideways}\hspace{\vs cm}$\Lambda=3000$\end{sideways}
%		&\includegraphics[width=\wf]{\dirim int3000_d50}
%		&\includegraphics[width=\wf]{\dirim int3000_d100}
%		&\includegraphics[width=\wf]{\dirim int3000_d150}
%		&\includegraphics[width=\wf]{\dirim int3000_d200}
%		&\includegraphics[width=\wf]{\dirim int3000_d250}
%		&\includegraphics[width=\wf]{\dirim int3000_d300}\\
		\begin{sideways}\hspace{\vs cm}$\Lambda=500$\end{sideways}
		&\includegraphics[width=\wf]{\dirim int500_d10}
		&\includegraphics[width=\wf]{\dirim int500_d50}
		&\includegraphics[width=\wf]{\dirim int500_d100}
		&\includegraphics[width=\wf]{\dirim int500_d200}
		&\includegraphics[width=\wf]{\dirim int500_d300}
		&\includegraphics[width=\wf]{\dirim int500_d400}\\		
		\begin{sideways}\hspace{\vs cm}$\Lambda=1000$\end{sideways}
		&\includegraphics[width=\wf]{\dirim int1000_d10}
		&\includegraphics[width=\wf]{\dirim int1000_d50}
		&\includegraphics[width=\wf]{\dirim int1000_d100}
		&\includegraphics[width=\wf]{\dirim int1000_d200}
		&\includegraphics[width=\wf]{\dirim int1000_d300}
		&\includegraphics[width=\wf]{\dirim int1000_d400}\\
		\begin{sideways}\hspace{\vs cm}$\Lambda=1500$\end{sideways}
		&\includegraphics[width=\wf]{\dirim int1500_d10}
		&\includegraphics[width=\wf]{\dirim int1500_d50}
		&\includegraphics[width=\wf]{\dirim int1500_d100}
		&\includegraphics[width=\wf]{\dirim int1500_d200}
		&\includegraphics[width=\wf]{\dirim int1500_d300}
		&\includegraphics[width=\wf]{\dirim int1500_d400}\\		
		\begin{sideways}\hspace{\vs cm}$\Lambda=2000$\end{sideways}
		&\includegraphics[width=\wf]{\dirim int2000_d10}
		&\includegraphics[width=\wf]{\dirim int2000_d50}
		&\includegraphics[width=\wf]{\dirim int2000_d100}
		&\includegraphics[width=\wf]{\dirim int2000_d200}
		&\includegraphics[width=\wf]{\dirim int2000_d300}
		&\includegraphics[width=\wf]{\dirim int2000_d400}\\
		\begin{sideways}\hspace{\vs cm}$\Lambda=2500$\end{sideways}
		&\includegraphics[width=\wf]{\dirim int2500_d10}
		&\includegraphics[width=\wf]{\dirim int2500_d50}
		&\includegraphics[width=\wf]{\dirim int2500_d100}
		&\includegraphics[width=\wf]{\dirim int2500_d200}
		&\includegraphics[width=\wf]{\dirim int2500_d300}
		&\includegraphics[width=\wf]{\dirim int2500_d400}\\		
		\hline	
		&$d=10$ & $d=50$ & $d=100$ & $d=200$ & $d=300$ & $d=400$\\
	\end{tabular}
	\caption{Two simulated sources separated by distance $d$ [nm] with intensity $\Lambda$ [total number of emitted photons per source]. The background was set to $b=100$ photons/pixel and the images were corrupted with Poisson noise. The red dots indicate the positions of the sources. Numbers in the top-left and bottom-left corner of each figure state the ratio $r_B=\unit{FREM}^{Blink}/d$ and $r_S=\unit{FREM}^{Stat}/d$ for the blinking and the static situation, respectively. The smaller the values, the higher the precision of the distance estimator. The classical resolution limit (radius of an Airy disk) corresponds to $\delta=320$ nm.}
	\label{fig:two sources int d}
\end{figure}

\clearpage
\begin{figure}[!bh]
	\centering
	\newcommand{\wf}{.48\textwidth}
	\subfloat[b=100]{
	\includegraphics[width=\wf]{\qd gFREM/FREMdip_Lambda500_b100}
	\label{fig:FREM dip}}
	\subfloat[b=0]{
	\includegraphics[width=\wf]{\qd gFREM/FREMdip_Lambda500_b0}
	\label{fig:FREM dip b=0}}
	\caption{FREM and measured standard deviation ($\sqrt{\var(d)}$) for the estimation of the separation between two simulated noisy static sources ($\Lambda_1=\Lambda_2=500$ photons). A homogeneous background of (a) $b=100$ photons/pixel and (b) $b=0$ photons/pixel was added to each simulated image before realisaton of Poissoin noise. FREM is shown as a red dashed line. Estimated standard deviation from 1000 different realisation of the Poisson noise is plotted with blue circles.}
\end{figure}

FREM formula for static sources derived from \autoref{eq:FI - individual} shows an interesting behaviour for weak sources with large background values. Red dashed curve in \autoref{fig:FREM dip} shows FREM for two sources of equal intensity $\Lambda_1=\Lambda_2=500$ photons with background $b=100$ photons/pixel. This parameter settings corresponds to the top line in \autoref{fig:two sources int d}. Contrary to our intuition, FREM is not monotonic with separation $d$ and FREM curve shows a ``dip'' for $d\approx300$ nm. This suggests that there is an ``optimal'' distance $d$ between the sources for which the separation can be estimated with highest precision.

After careful checking of the derivation and numerical calculations of the curves, we interpret the dip to be a result of two competing factors. First factor is the decrease of FREM with increasing separation $d$. Our intuitive expectation is that the distance between well separated sources is easier to measure than for the close, overlapping ones. However, in the case of weak sources surrounded with large background, the well separated weak sources disappear in noise resulting from large background values (cf. right figure on the top line in \autoref{fig:two sources int d}). If the sources are close to each other and their PSFs overlap, the sum of their PSFs create a brighter object, which is easier to find in high background noise (middle of the top line in \autoref{fig:two sources int d}). The ``visibility'' of the overlapped sources increases with decreasing $d$ and represents the second competing factor. The dip in FREM curves is then an ``optimal separation'' $d$, where sources are already sufficiently separated to be localised with good precision but still vell visible due to their overlap. The increase of the localisation precision with further increasing separation is not sufficient to compensate for the fact that sources ``disappear'' in noise.

A qualitative confirmation of this contra-intuitive behaviour of FREM curves is shown on simulated data. We simulated two sources separated with distance $d$. The intensity and the background was set to the same values as for the theoretical FREM curves ($\Lambda_1=\Lambda_2=500$ photons, $b=100$ photons/pixel). For each separation $d$ we created $M=1000$ images with different realisation of Poisson noise. Using MATLAB function {\tt fminsearch}, we found the maximum-likelihood estimator of the positions $\bm{c}_{ML}=(c^{ML}_1,c^{ML}_2)$ of two PSFs (see \autoref{eq:intensity pixel}). The initial position for fit was set to the true values $\bm{c}_{true}$. The standard deviation of the $M$ separation estimators $d^{ML}=|c^{ML}_1-c^{ML}_2|$ is plotted with blue circles in \autoref{fig:FREM dip} and shows similar ``dip'' as the theoretical FREM curve.

Dashed red line in \autoref{fig:FREM dip b=0} shows that FREM is monotonically decreasing with $d$ for zero background ($b=0$) situation. Qualitative confirmation of the theoretical curve by fitting the simulated data is plotted with blue circles in \autoref{fig:FREM dip b=0}. No dip is observed in this case. 

The measured standard deviation (blue circles) shows lower values then the theoretical lower bound (red dashed curve). This is due to the initialisation of the maximum-likelihood fitting with $\bm{c}_{true}$. Random initialisation would be more appropriate, but the measured standard (above the FREM curve) does not provide curves smooth enough to show the ``dip'' clearly. 


%==========================================
%==========================================
\clearpage
\section{Discussion\label{sec:FREM discussion}}
This discussion consists of several sections. In \autoref{sub:LL surface} we give some insight to the behaviour of FREM in the limiting situation $d\rightarrow0$ and $d\rightarrow\infty$ by visualisation of the expected log-likelihood surface and considering the Fisher information as a measure of the surface's curvature. We give a qualitative explanation of the incorrect behaviour of the original FREM formula in the limits.  

\Autoref{sub:Int out vs avg} compares the difference between the averaging and integrating over the intensity states $\bm{\Lambda^\alpha}$ in the Fisher information matrix for blinking sources.

%==========================================
\subsection{Visualisation of the expected log-likelihood surface\label{sub:LL surface}}
\begin{figure}[hbt!]
	\centering
	\newcommand{\sizeff}{.18}
	\newcommand{\sizegg}{.16}
	\newcommand{\ndir}{\qd gFREM/images/LLsurface/}
	\begin{tabular}{cccc}
		\subfloat[$d=300$ nm]{\includegraphics[scale=\sizegg]{\ndir surf_d300_int11000_int21000_bg100}} 		
		& \subfloat[$d=200$ nm]{\includegraphics[scale=\sizegg]{\ndir surf_d200_int11000_int21000_bg100}} 		
		& \subfloat[$d=50$ nm]{\includegraphics[scale=\sizegg]{\ndir surf_d50_int11000_int21000_bg100}} 		
		& \subfloat[$d=0$ nm]{\includegraphics[scale=\sizegg]{\ndir surf_d0_int11000_int21000_bg100}} 		
		\tabularnewline
		\subfloat[$d=300$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d300_int11000_int21000_bg100}} 
		& \subfloat[$d=200$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d200_int11000_int21000_bg100}} 		
		& \subfloat[$d=50$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d50_int11000_int21000_bg100}} 		
		& \subfloat[$d=0$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d0_int11000_int21000_bg100}} 		
		\tabularnewline
	\end{tabular}
	\caption{Surface of the expected log-likelihood \autoref{eq:Expected log-likelihood} as a function of $\bm{c}=(c_1,\, c_2)$ for different separation $d$ between the two sources, located at $\bm{c}^{true}$ (marked with red dot). The point where the sources exchange their locations is marked with blue cross. Classical resolution limit corresponds to $\delta=320$ nm. Movement along the ``top-left to bottom-right'' diagonal represents moving the points apart (see \autoref{fig:FI space demo} for details).}	
	\label{fig:Expected-log-likelihood-Surface}
\end{figure}

In order to understand the behaviour of the Fisher information matrix, we visualised the surface of the expected log-likelihood \autoref{eq:FREM likelihood Poisson} as a function of the parameter $\bm{c}=(c_1,\, c_2)$ in \autoref{fig:Expected-log-likelihood-Surface}:
%
\begin{alignat}{2}
	\E_{p(n|\lambda^{true})}\left[\mathcal{L}(\bm{c})\right]
	&=\E_{p(n|\lambda^{true})}\left[\sum_{k=1}^N\log p\left(n_k|\lambda_k(\bm{c})\right)\right]\nonumber\\
	&=\sum_{k=1}^N\left(\lambda_k^{true}\log\lambda_k(\bm{c})-\lambda_k(\bm{c})\right)+A.
	\label{eq:Expected log-likelihood}
\end{alignat}
%
Note that the expectation is taken with respect to the ``true'' distribution $\lambda^{true}=\lambda(\bm{c}^{true})$, while the log-likelihood $\mathcal{L}$ is a function of $\bm{c}$. $A$ is independent of $\bm{c}$. 

The surface in \autoref{fig:Expected-log-likelihood-Surface} shows how likely on average is a model with two sources $s_1$ and $s_2$ located at $c_1$ and $c_2$, respectively, for data generated from a model consisting of two sources $s_1^{true}$ and $s_2^{true}$ located at $c_1^{true}$ and $c_2^{true}$, respectively, corrupted with Poisson noise. Parameters of the simulation were $\Lambda=10^3$, $b=100$ and wavelength $625 \unit{nm}$.

\begin{figure}[hb]
	\newcommand{\wf}{.48\textwidth}
	\centering
	\subfloat[]{\includegraphics[width=\wf]{./figures/FisherInfoSurfaceMovementDemo/FIsurfaceDemo1}\label{fig:FI space demo1}} 
	\subfloat[]{\includegraphics[width=\wf]{./figures/FisherInfoSurfaceMovementDemo/FIsurfaceDemo2}\label{fig:FI space demo2}} \\
	\subfloat[]{\includegraphics[width=\wf]{./figures/FisherInfoSurfaceMovementDemo/FIsurfaceDemo3}\label{fig:FI space demo3}} 
	\subfloat[]{\includegraphics[width=\wf]{./figures/FisherInfoSurfaceMovementDemo/FIsurfaceDemo4}\label{fig:FI space demo4}} 
	\caption{Illustration of the translation of sources $s_1$ and $s_2$ along line $l$ and the corresponding movement in the parameter space from \autoref{fig:Expected-log-likelihood-Surface}.}
	\label{fig:FI space demo}
\end{figure}
%
Correspondance between the $(c_1,c_2)$ space of \autoref{fig:Expected-log-likelihood-Surface} and the movement of the sources is illustrated in \autoref{fig:FI space demo}. The coordinates $(c_1,c_2)$ represent the positions of two sources on a line $l$ intersecting both sources $s_1$ and  $s_2$. The origin $o=(0,0)$ corresponds to the geometrical centre between $c_1^{true}$ and $c_2^{true}$. Moving along the top-left to bottom-right diagonal (\autoref{fig:FI space demo1}) represents symmetrical movement of $s_1$ and $s_2$  in opposite directions with respect to $o$, while moving parallel to the top-right to bottom-left diagonal (\autoref{fig:FI space demo2}) represents the translation of $s_1$ and $s_2$ together along $l$, while keeping their distance from each other. Moving along vertical line corresponds to the situation, where the position of $s_1$ fixed while $s_2$ is moving (\autoref{fig:FI space demo3}) and vice versa for horizontal lines (\autoref{fig:FI space demo4}).

For well separated sources the surface (\autoref{fig:Expected-log-likelihood-Surface}\aaa) has a sharp maximum at $\bm{c}^{true}=(c_1^{true},c_2^{true})$ (red dot in \autoref{fig:Expected-log-likelihood-Surface}\aaa). In fact, there is another equivalent maximum (blue cross in \autoref{fig:Expected-log-likelihood-Surface}\aaa) as the points are interchangeable.  The surface is therefore symmetrical along top-right to bottom-left diagonal. It is important to note that the surface falls sharply in all directions around the maximum. In other words, the likelihood of a model $s_1$ and $s_2$ for data generated from $s_1^{true}$ and $s_2^{true}$ drops quickly once the $s_1$ and $s_2$ move anywhere from the ``true'' locations $\bm{c}^{true}$.

Once the true sources $s_1^{true}$ and $s_2^{true}$ come closer together (\autoref{fig:Expected-log-likelihood-Surface}\bbb,\ccc), the maximum of the surface becomes less pronounced, especially along the top-left to bottom-right diagonal. The likelihood of a model $s_1$ and $s_2$ is not very sensitive to small symmetrical movement of $s_1$ and $s_2$ with respect to $o=(0,0)$. 

Once the sources $s_1^{true}$ and $s_2^{true}$ get very close, the saddle point in $o$ disappears and turns into a flat crest (\autoref{fig:Expected-log-likelihood-Surface}\ddd). The likelihood becomes insensitive to small variations of $s_1$ and $s_2$. 

The Fisher information matrix \autoref{eq:Fisher information general} describes the curvature (Hessian) at $\bm{c}^{true}$ (red dot in \autoref{fig:Expected-log-likelihood-Surface}\aaa). For well separated sources \autoref{fig:Expected-log-likelihood-Surface}\aaa\ the curvature is very high in all directions, resulting in large determinant of the Hessian matrix, which in turn results in small variance $\var(d)$ of the distance $d=\left|c_1^{true}-c_2^{true}\right|$ estimation  (see \autoref{eq:inverse I}). Once the ``true'' sources get closer, the curvature at the surface maximum decreases leading to larger $\var(d)$. For very close ``true'' sources, the determinant of Hessian become zero, and the lower bound on $\var(d)$ diverges. 

The situation of infinitely close sources $c_1^{true}=c_1^{true}$, shown in \autoref{fig:Expected-log-likelihood-Surface}\ddd\  is equivalent to the situation with one source of double intensity and the second source missing, giving divergence of $\var(d)$ in accordance with our discussion of \autoref{eq:FI - individual} in the limits  (see \autoref{sec:Appendix FI alternative} in \autoref{app:Appendix2}).

\begin{figure}[!thb]
	\centering
	\newcommand{\sizeff}{.18}
	\newcommand{\sizegg}{.16}
	\newcommand{\ndir}{\qd gFREM/images/LLsurface/}
	\begin{tabular}{cccc}
		\subfloat[$d=300$ nm]{\includegraphics[scale=\sizegg]{\ndir surf_d300_int11000_int22000_bg100}} 		
		& \subfloat[$d=200$ nm]{\includegraphics[scale=\sizegg]{\ndir surf_d200_int11000_int22000_bg100}} 		
		& \subfloat[$d=50$ nm]{\includegraphics[scale=\sizegg]{\ndir surf_d50_int11000_int22000_bg100}} 		
		& \subfloat[$d=0$ nm]{\includegraphics[scale=\sizegg]{\ndir surf_d0_int11000_int22000_bg100}} 		
		\tabularnewline
		\subfloat[$d=300$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d300_int11000_int22000_bg100}} 
		& \subfloat[$d=200$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d200_int11000_int22000_bg100}} 		
		& \subfloat[$d=50$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d50_int11000_int22000_bg100}} 		
		& \subfloat[$d=0$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d0_int11000_int22000_bg100}} 		
		\tabularnewline
	\end{tabular}
	\caption{Surface of the expected log-likelihood \autoref{eq:Expected log-likelihood} as a function of $\bm{c}=(c_1,\, c_2)$ for different separation $d$ between the two sources of unequal intensity $\Lambda_2=2\Lambda_1$, located at $\bm{c}^{true}$ (marked with red dot). The position where the sources exchange their true locations is marked with blue cross.}	
	\label{fig:LL surf different intensity}
\end{figure}
%
The symmetry of the surface breaks when we consider two sources with unequal intensity ($\Lambda_1\neq\Lambda_2$), because such sources are no longer interchangeable. The situation for $\Lambda_2=2\Lambda_1$ is shown in \autoref{fig:LL surf different intensity}. The displacement of the stronger source ($s_2$), which corresponds to the movement along the vertical lines in \autoref{fig:LL surf different intensity}\eee-\hhh\ (see \autoref{fig:FI space demo} for explanation), has a dramatic effect on the likelihood of the model. The surface drops steeply in the horizontal direction, while decreases rather slowly along the horizontal line (displacement of the weaker source $s_1$). For the limit $d\rightarrow 0$, shown in \autoref{fig:LL surf different intensity}\ddd,\hhh, the flat crest in the origin still exist (which results divergence of $\var(d)$), however it is not aligned with the top-left to bottom-right diagonal as for the equal sources (see \autoref{fig:Expected-log-likelihood-Surface}\ddd,\hhh). There is a non-zero curvature along this diagonal.

Fisher information for the original FREM formula (\autoref{eq:Ram FREM}) is derived from the curvature of the surface along the top-left to bottom-right diagonal (symmetrical displacement of the sources with respect to the origin cf. \autoref{fig:FI space demo}). For the symmetrical situation $\Lambda_1=\Lambda_2$ the original FREM gives the correct results (see \autoref{app:Appendix2} for mathematical explanation), however, for the asymmetrical case $\Lambda_1\neq\Lambda_2$ the non-zero curvature along the diagonal results in finite FREM even for the limit $d\rightarrow 0$. Our proposed derivation of FREM from the Fisher information matrix (see \autoref{eq:var d from Q}) accommodates for the unequal sources correctly and gives diverging FREM for this limit. 

%==========================================
\subsection{Integrating out $\Lambda$ vs averaging\label{sub:Int out vs avg}}
\begin{figure}[!hbt]
	\centering
	\newcommand{\wf}{.49\textwidth}
		\subfloat[FREM (fixed $b=$100 phot/pixel)]{\includegraphics[width=\wf]{\qd gFREM/images/FREM_intoutVSavg_bg100fix}
		\label{fig:FREM fixed bg}}
		\subfloat[Ratio of the curves form (a)]{\includegraphics[width=\wf]{\qd gFREM/images/FREM_intoutVSavg_ratio_bg100fix}
		\label{fig:FREM ratio fixed bg}}
	\caption{(a) Comparison of FREM computed from the Fisher information with integration over the states within the log-likelihood function \autoref{eq:FREM likelihood Lambda integrated out} (dashed lines) and the averaging of the Fisher information over different intensity states $\Lambda^{\alpha}$ \autoref{eq:FI avg} (solid lines). Dotted black lines corresponds to FREM$=d$ border. (b) Ratio of the ``sum'' (solid) to ``averaging'' (dashed) FREM curves. It shown how many times is the ``averaging'' FREM smaller then FREM derived from integrating over the states in Fisher information matrix.}
	\label{fig:FREM int out vs avg}
\end{figure}
% 
As we pointed out in \autoref{sec:FREM for blinking}, in the real situation we do not know the intensity states $\bm{\Lambda^{\alpha}}$ (see \autoref{eq:intensity states}) of the individual emitters in each frame. Therefore  we have to integrate (sum) over these states within the likelihood function \autoref{eq:FREM likelihood Lambda integrated out}, rather then average the Fisher information over different configurations of $\bm{\Lambda^{\alpha}}$ as in \autoref{eq:FI avg}. 

To further emphasise the difference between the ``integrating over states in'' and ``averaging of'' Fisher information we plot FREM as a function of the separation $d$ for both concepts in \autoref{fig:FREM int out vs avg}.

FREM computed from the averaged Fisher information is consistently lower for the whole range of $d$. The difference is less pronounced for data with higher signal-to-noise ratio (red curves). In the limit of well separated sources $d\rightarrow\infty$ and the ``averaging'' FREM reduces to the situation described by the static with half number of total number photons as discussed in \autoref{sub:FREM static vs blinking}. Therefore for zero background values both expressions gives equal values of FREM for well separated sources ($d\rightarrow\infty$), as discussed in \autoref{app:Appendix2}.

Note, that the averaging approach does not give divergence of the FREM for $d\rightarrow 0$ limit (see \autoref{fig:FREM int out vs avg}\aaa). This is due to the fact that we assume the configuration of the intensity state in each frame to be known. We can therefore determine the position of each source individually from the frames, when only one source is emitting ($\bm{\Lambda^{\alpha=1}}$ and $\bm{\Lambda^{\alpha=2}}$ in \autoref{eq:intensity states}). The averaging \autoref{eq:FI avg} fills in the (otherwise zero) diagonal entries of the Fisher information matrix with non-zero values and we get a finite precision for separation estimation even when $d=0$.

%==========================================

\subsection{Scaling of FREM for different levels of intensity and background\label{sub:scaling}}

The Fisher information matrix \autoref{eq:FI - individual - equal strength} for two sources with equal (static) intensity $\Lambda_1=\Lambda_2=\Lambda$ suggest that if we increase the intensity of the sources and the background value by a factor of $N$, we get $N$ times higher Fisher information matrix entries
%
\begin{equation}
	\left\{I_{\Lambda,b}^{S}\right\}_{ij}=\Lambda\frac{A}{B+b/\Lambda},
	\label{eq:FI static on lambda b}
\end{equation}
%
where $A$ and $B$ are independent of $\Lambda$ and $b$. The superscript $S$ in the $I^S$ denotes the that the Fisher information is computed for static sources, while the subscript $\Lambda,\,b$ in $I_{\Lambda,b}$ express the parametric dependency of the Fisher information on the intensity and background values.  Note that the background and intensity appears as a ratio $b/\Lambda$ in the expression, but the whole expression is multiplied by $\Lambda$. 

Substitution in \autoref{eq:variance d alternative} shows that the variance decreases proportionally to $1/\Lambda$. In the language of a microscope experiment this means that an $N$ fold time increase of the acquisition time ($N$ fold increase of the total number of emitted photons and of the background level $b$) will allow for $\sqrt{N}$ fold higher precision of the separation $d$ estimation.

The scaling with $\Lambda$ and $b$ of the Fisher information entries for the blinking case is more complicated. In \autoref{app:Appendix2} we show, the blinking situation gives results equal to the static situation (up to a factor of 1/2 accounting for the half of the total number of emitted photons) for the limit of well separated sources ($d\rightarrow\infty$) and zero background (see \autoref{eq:app-FREM blink lim infty b=0} in \autoref{app:Appendix2}). 

In the non-zero background situation, $b$ appears within the argument of Poisson terms organised in a complicated fraction (see \autoref{eq:app-FREM blink limit infty bg} in \autoref{app:Appendix2}). The dependence of the Fisher information matrix entries on the background is therefore highly non-linear, which is especially pronounced for low signal-to-noise ratios.  



%\begin{figure}[thb]
%	\centering
%	\newcommand{\sizeff}{.18}
%	\newcommand{\sizegg}{.16}
%	\newcommand{\ndir}{\qd gFREM/images/LLsurface/}
%	\begin{tabular}{cccc}
%		\subfloat[$d=400$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d400_int11000_int21000_bg100}} 
%		& \subfloat[$d=300$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d300_int11000_int21000_bg100}} 		
%		& \subfloat[$d=200$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d200_int11000_int21000_bg100}} 		
%		& \subfloat[$d=100$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d100_int11000_int21000_bg100}} 		
%		\tabularnewline
%		\subfloat[$d=400$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d400_int1500_int2500_bg100}} 
%		& \subfloat[$d=300$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d300_int1500_int2500_bg100}} 		
%		& \subfloat[$d=200$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d200_int1500_int2500_bg100}} 		
%		& \subfloat[$d=100$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d100_int1500_int2500_bg100}} 		
%		\tabularnewline
%		\subfloat[$d=400$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d400_int1500_int2500_bg500}} 
%		& \subfloat[$d=300$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d300_int1500_int2500_bg500}} 		
%		& \subfloat[$d=200$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d200_int1500_int2500_bg500}} 		
%		& \subfloat[$d=100$ nm]{\includegraphics[scale=\sizegg]{\ndir cont_d100_int1500_int2500_bg500}} 		
%
%	\end{tabular}
%	\caption{Top row: int=1000, bg=100; bottom int=1000, bg=100}	
%\end{figure}
%



%% This is for discussion
%In the blinking case \autoref{eq:Fisher Information Blinking Integrating Out} the dependency on $\Lambda$ is complicated as the expectation in \autoref{eq:Fisher Information Blinking Integrating Out} cannot be simplified and $\var(d)$ depends on $\Lambda$ through the parameter $\lambda_k^i(\Lambda)$ of the Poisson distribution in \autoref{eq:Fisher Information Blinking Integrating Out}. This gives rise to a non-linear relationship between $\var(d)$ and $\Lambda$.
%%
%The comparison of the blinking and the static case for three different values of the mean source intensity $\Lambda$ is shown in \autoref{fig:FREM static blinking}\aaa. In this figure the background intensity was fixed to $bg=100$~photons. The intensity of the blinking sources was set to $2\Lambda$ to keep the mean number of detected photons constant for the static and the blinking case (the blinking sources are on average `ON' only half of the time and so the average intensity is $\Lambda$). 
%
%Localisation precision $\sqrt{\var(d)}$ for two sources separated by 40~nm with equal intensities $\Lambda=10^3$ photons for different background levels is shown in \autoref{fig:effect of the background and illustration of the noisy sources with background}\aaa. This graph correspond to two sources separated by $d=40$~nm with $\Lambda=10^3$~photons ($2\Lambda$ for blinking case). For lower background ($bg<200$) the blinking sources allow higher localisation precision (lower $\var(d)$). Illustration of this data with different background levels is shown in \autoref{fig:effect of the background and illustration of the noisy sources with background}b-e. 
%
%%==========================================
%%==========================================
%
%\section{Conclusions} 
%
%The alternative derivation of the FREM provides correction to the formula published in \cite{Ram2006}. Results presented in \autoref{fig:FREM static blinking} suggest that the in certain setting (bright sources low background) the blinking sources can significantly increase the localisation precision compared to the static situation. This effect is stronger for close ($d<50\unit{nm}$) and bright ($\Lambda>1000\ \unit{photons}$) sources with lower background levels ($bg<100$). This corresponds to a realistic setting for QD data (simulated data shown in \autoref{fig:effect of the background and illustration of the noisy sources with background}\ccc). For well separated sources ($d\rightarrow\infty$ limit) the static situation provides lower bound for the localisation precision. 
%
%The regions where the blinking is preferable to the static case depends on the intensity of the sources (\autoref{fig:FREM static blinking}\aaa) as well as on the background levels (\autoref{fig:FREM static blinking}\bbb). Background have a large impact on the localisation precision as shown in \autoref{fig:effect of the background and illustration of the noisy sources with background} and it is desirable to keep is as low as possible. In practice a large proportion of the background intensity comes from the out of focus light. Typically TIRF (Total Internal Reflection Fluorescent microscopy) illumination of the sources is used to reduce the out-of-focus blur. However, different techniques such as local illumination of the sample can be used. 
%
%In summary the bright sources (high signal-to-noise ratio) are desirable for the LM techniques. In this setting the blinking can provide higher localisation precision for closely spaced sources. QDs can be an order of magnitude brighter then the organic fluorescent markers (\autoref{sub:Quantum-dots}) and are promising candidates for LM. However, the Fisher information approach gives a lower bound for the variance. The actual localisation precision for the blinking sources depend on the ability to separate the individual emitters. This can be challenging for closely spaced sources and the separation might be the actual limiting factor for the localisation precision.
